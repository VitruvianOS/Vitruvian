name: Increment rev tag on push
on:
  push:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  increment-rev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pushed ref
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # needed to list tags and read history

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Find latest rev tag
        id: find_latest
        run: |
          # Pattern: rev-<number>
          latest=$(git tag --list 'rev-*' --sort=-v:refname | head -n1 || true)
          if [ -z "$latest" ]; then
            echo "latest="
            echo "::set-output name=latest::"
          else
            # extract number suffix
            num=${latest#rev-}
            echo "latest=$latest"
            echo "::set-output name=latest::$latest"
            echo "::set-output name=num::$num"
          fi

      - name: Determine next rev number
        id: next_rev
        run: |
          latest="${{ steps.find_latest.outputs.latest }}"
          num="${{ steps.find_latest.outputs.num }}"
          if [ -z "$latest" ]; then
            next=1
          else
            # guard: ensure numeric
            if echo "$num" | grep -Eq '^[0-9]+$'; then
              next=$((num + 1))
            else
              next=1
            fi
          fi
          tag="rev-${next}"
          echo "::set-output name=tag::$tag"
          echo "::set-output name=number::$next"

      - name: Create and push rev tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ steps.next_rev.outputs.tag }}"
          echo "Creating tag $tag at $GITHUB_SHA"
          git tag "$tag" "$GITHUB_SHA"
          # Push tag using token auth
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "refs/tags/${tag}"

      - name: Output
        run: |
          echo "Created tag: ${{ steps.next_rev.outputs.tag }}"
