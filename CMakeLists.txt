cmake_minimum_required(VERSION 3.25 FATAL_ERROR)

project(VOS VERSION 0.2.5 LANGUAGES CXX C)

# TODO shouldn't we resolve an absolute path here? it kind of works
# only if buildtools is in the project source dir, which...we don't
# really want to constrain.
if(NOT BUILDTOOLS_DIR AND NOT BUILDTOOLS_MODE STREQUAL "1")
	message( FATAL_ERROR "Buildtools path not defined!" )
endif()

file(WRITE "${CMAKE_BINARY_DIR}/buildconfig.conf"
"# Auto-generated by CMake - do not edit
CMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
")
message(STATUS "Build config written to: ${CMAKE_BINARY_DIR}/buildconfig.conf")

include(build/engine.cmake)

add_subdirectory(src)

if(NOT BUILDTOOLS_MODE STREQUAL "1")
	include(build/packages.cmake)
	set(BUILDTOOLS_MODE "no" )
endif()

if(CMAKE_BUILD_TYPE STREQUAL "Debug")
  set(IS_DEBUG_MODE "yes")
else()
  set(IS_DEBUG_MODE "no")
endif()

if(NOT DEFINED GUEST_KERNEL OR GUEST_KERNEL STREQUAL "")
  set(GUEST_KERNEL "Native build" CACHE STRING "Guest kernel type" FORCE)
endif()

message(STATUS "")
message(STATUS "============= Build environment =============")
message(STATUS "CMAKE_SYSTEM:                    ${CMAKE_SYSTEM}")
message(STATUS "CMAKE_SYSTEM_PROCESSOR:          ${CMAKE_SYSTEM_PROCESSOR}")
message(STATUS "CMAKE_SIZEOF_VOID_P:             ${CMAKE_SIZEOF_VOID_P}")
message(STATUS "CMAKE_C_FLAGS:                   ${CMAKE_C_FLAGS}")
message(STATUS "CMAKE_CXX_FLAGS:                 ${CMAKE_CXX_FLAGS}")
message(STATUS "CMAKE_BUILD_TYPE:                ${CMAKE_BUILD_TYPE}")
message(STATUS "CMAKE_C_COMPILER:                ${CMAKE_C_COMPILER}")
message(STATUS "CMAKE_CXX_COMPILER:              ${CMAKE_CXX_COMPILER}")
message(STATUS "CMAKE_AR:                        ${CMAKE_AR}")
message(STATUS "CMAKE_RANLIB:                    ${CMAKE_RANLIB}")
message(STATUS "=============================================")
message(STATUS "BUILDTOOLS_MODE:                 ${BUILDTOOLS_MODE}")
message(STATUS "BUILDTOOLS_DIR:                  ${BUILDTOOLS_DIR}")
message(STATUS "BUILD_TESTS:                     ${IS_DEBUG_MODE}")
message(STATUS "=============================================")
message(STATUS "Host kernel:                     ${HOST_KERNEL}")
message(STATUS "Guest kernel:                    ${GUEST_KERNEL}")
message(STATUS "SSH Debug:                       ${IS_DEBUG_MODE}")
message(STATUS "=============================================")
message(STATUS "")
