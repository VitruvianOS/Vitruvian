name: Push -> Telegram (read-only tags)
on:
  push:
    branches:
      - '**'

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pushed ref (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find latest rev tag
        id: latest
        run: |
          # find latest rev-* tag by creation date; leave empty if none
          entry=$(git for-each-ref --sort=-creatordate --format='%(refname:short) %(creatordate:unix)' refs/tags | grep '^rev-[0-9]\+' | head -n1 || true)
          if [ -z "$entry" ]; then
            echo "::set-output name=tag::"
            echo "::set-output name=ts::"
          else
            tag=$(echo "$entry" | awk '{print $1}')
            ts=$(echo "$entry" | awk '{print $2}')
            echo "::set-output name=tag::$tag"
            echo "::set-output name=ts::$ts"
          fi

      - name: Build Telegram message
        id: message
        run: |
          repo="${GITHUB_REPOSITORY}"
          branch="${GITHUB_REF#refs/heads/}"
          sha_full="${GITHUB_SHA}"
          sha="${sha_full::7}"
          author="$(git --no-pager show -s --format='%an' $GITHUB_SHA || echo '')"
          msg="$(git --no-pager show -s --format='%s' $GITHUB_SHA || echo '')"
          latest_tag="${{ steps.latest.outputs.tag }}"
          tag_part="Rev: ${latest_tag:-(none)}"
          body="Repo: ${repo}%0ABranch: ${branch}%0ACommit: ${sha}%0AAuthor: ${author}%0AMessage: ${msg}%0A${tag_part}"
          echo "::set-output name=body::$body"

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID secrets; skipping send."
            exit 0
          fi
          body="${{ steps.message.outputs.body }}"
          curl -sS --fail -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${body}" \
            -d "parse_mode=HTML"
