name: Increment rev tag and notify chat
on:
  push:
    branches:
      - '**'

permissions:
  contents: write

env:
  # URL templates used in message formatting
  REPO_URL: https://github.com/${{ github.repository }}
  TAG_URL_PREFIX: https://github.com/${{ github.repository }}/releases/tag
  COMMIT_URL_PREFIX: https://github.com/${{ github.repository }}/commit

jobs:
  rev_and_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pushed ref (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # needed to list tags and read history

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Find latest rev tag (by name)
        id: find_latest_by_name
        run: |
          # Pattern: rev-<number>, sort by semver-ish refname
          latest=$(git tag --list 'rev-*' --sort=-v:refname | head -n1 || true)
          if [ -z "$latest" ]; then
            echo "::set-output name=latest::"
            echo "::set-output name=num::"
          else
            num=${latest#rev-}
            if echo "$num" | grep -Eq '^[0-9]+$'; then
              echo "::set-output name=latest::$latest"
              echo "::set-output name=num::$num"
            else
              echo "::set-output name=latest::"
              echo "::set-output name=num::"
            fi
          fi

      - name: Determine next rev number
        id: next_rev
        run: |
          latest="${{ steps.find_latest_by_name.outputs.latest }}"
          num="${{ steps.find_latest_by_name.outputs.num }}"
          if [ -z "$latest" ]; then
            next=1
          else
            next=$((num + 1))
          fi
          tag="rev-${next}"
          echo "Next tag will be: $tag"
          echo "::set-output name=tag::$tag"
          echo "::set-output name=number::$next"

      - name: Create and push rev tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ steps.next_rev.outputs.tag }}"
          sha="${GITHUB_SHA}"
          echo "Creating tag $tag at $sha"
          # Annotated tag to carry message/author metadata
          git tag -a "$tag" -m "Incremented rev to $tag" "$sha"
          # Push tag using token auth (explicit URL avoids default remote issues)
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "refs/tags/${tag}"

      - name: Find latest rev tag (by creation date)
        id: latest_by_date
        run: |
          # find latest rev-* tag by creation date; leave empty if none
          entry=$(git for-each-ref --sort=-creatordate --format='%(refname:short) %(creatordate:unix)' refs/tags | grep '^rev-[0-9]\+' | head -n1 || true)
          if [ -z "$entry" ]; then
            echo "::set-output name=tag::"
            echo "::set-output name=ts::"
          else
            tag=$(echo "$entry" | awk '{print $1}')
            ts=$(echo "$entry" | awk '{print $2}')
            echo "::set-output name=tag::$tag"
            echo "::set-output name=ts::$ts"
          fi

      - name: Build Telegram message (HTML)
        id: message
        run: |
          repo="${GITHUB_REPOSITORY}"
          repo_url="${REPO_URL}"
          branch="${GITHUB_REF#refs/heads/}"
          sha_full="${GITHUB_SHA}"
          sha_short="${sha_full::7}"
          author="$(git --no-pager show -s --format='%an' $GITHUB_SHA || echo '')"
          commit_msg="$(git --no-pager show -s --format='%s' $GITHUB_SHA || echo '')"
          latest_tag="${{ steps.latest_by_date.outputs.tag }}"
          # Resolve URLs; if tag created in this run use that tag, else use latest_by_date
          # Prefer the tag we just created (next_rev) to avoid mismatch
          created_tag="${{ steps.next_rev.outputs.tag }}"
          chosen_tag="${created_tag:-$latest_tag}"
          # Build clickable HTML pieces (Telegram supports basic HTML)
          repo_html="<a href=\"${repo_url}\">${repo}</a>"
          commit_url="${COMMIT_URL_PREFIX}/${sha_full}"
          commit_html="<a href=\"${commit_url}\">${sha_short}</a>"
          if [ -n "$chosen_tag" ]; then
            tag_url="${TAG_URL_PREFIX}/${chosen_tag}"
            tag_html="<a href=\"${tag_url}\">${chosen_tag}</a>"
            tag_text="Rev: ${tag_html}"
          else
            tag_text="Rev: (none)"
          fi
          # Escape special HTML chars in author and commit_msg
          esc_author=$(printf '%s' "$author" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          esc_msg=$(printf '%s' "$commit_msg" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          body="Repo: ${repo_html}%0ABranch: ${branch}%0ACommit: ${commit_html}%0AAuthor: ${esc_author}%0AMessage: ${esc_msg}%0A${tag_text}"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${body}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Preview Telegram message (log)
        if: always()
        run: |
          # Show a human-readable preview (unescaped)
          repo="${GITHUB_REPOSITORY}"
          repo_url="${REPO_URL}"
          branch="${GITHUB_REF#refs/heads/}"
          sha_full="${GITHUB_SHA}"
          sha_short="${sha_full::7}"
          author="$(git --no-pager show -s --format='%an' $GITHUB_SHA || echo '')"
          commit_msg="$(git --no-pager show -s --format='%s' $GITHUB_SHA || echo '')"
          chosen_tag="${{ steps.next_rev.outputs.tag }}"
          tag_display="${chosen_tag:-(none)}"
          echo "---- Telegram message preview ----"
          echo "Repo: ${repo} (${repo_url})"
          echo "Branch: ${branch}"
          echo "Commit: ${sha_short} (${COMMIT_URL_PREFIX}/${sha_full})"
          echo "Author: ${author}"
          echo "Message: ${commit_msg}"
          echo "Rev: ${tag_display} (${TAG_URL_PREFIX}/${tag_display})"
          echo "----------------------------------"

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID secrets; skipping send."
            exit 0
          fi
          body="${{ steps.message.outputs.body }}"
          # Send message as HTML to enable clickable links
          curl -sS --fail -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${body}" \
            -d "parse_mode=HTML"

      - name: Output created tag
        run: |
          echo "Created tag: ${{ steps.next_rev.outputs.tag }}"
