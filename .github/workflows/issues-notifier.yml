name: Notify Chat on issue open/close
on:
  issues:
    types: [opened, closed]

permissions:
  issues: read

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Read event JSON
        id: event
        run: |
          echo "event_path=${GITHUB_EVENT_PATH}" >> "$GITHUB_OUTPUT"

      - name: Build Telegram message
        id: build
        env:
          EVENT_PATH: ${{ steps.event.outputs.event_path }}
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            number=$(jq -r .issue.number "$EVENT_PATH")
            title=$(jq -r .issue.title "$EVENT_PATH")
            body_text=$(jq -r '.issue.body // ""' "$EVENT_PATH")
            user=$(jq -r .issue.user.login "$EVENT_PATH")
            url=$(jq -r .issue.html_url "$EVENT_PATH")
            labels=$(jq -r '[.issue.labels[]?.name] | join(", ")' "$EVENT_PATH")
            action=$(jq -r .action "$EVENT_PATH")
            actor=$(jq -r '.sender.login // ""' "$EVENT_PATH")
          else
            number="${{ github.event.issue.number }}"
            title="${{ github.event.issue.title }}"
            body_text="${{ github.event.issue.body || '' }}"
            user="${{ github.event.issue.user.login }}"
            url="${{ github.event.issue.html_url }}"
            labels="(none)"
            action="${{ github.event.action }}"
            actor="${{ github.actor }}"
          fi

          maxlen=800
          if [ "${#body_text}" -gt "$maxlen" ]; then
            body_text="${body_text:0:$maxlen}...(truncated)"
          fi

          esc() {
            printf '%s' "$1" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
          }

          repo="${GITHUB_REPOSITORY}"
          repo_url="https://github.com/${repo}"
          repo_link="<a href=\"${repo_url}\">${repo}</a>"
          issue_link="<a href=\"${url}\">#${number} ${esc "$title"}</a>"

          if [ "$action" = "opened" ]; then
            msg_title="New issue opened"
            body="Repo: ${repo_link}\nIssue: ${issue_link}\nAuthor: ${esc "$user"}\nLabels: ${esc "${labels:-(none)}"}\n\n${esc "$body_text"}"
          else
            msg_title="Issue closed"
            body="Repo: ${repo_link}\nIssue: ${issue_link}\nClosed by: ${esc "$actor"}\nLabels: ${esc "${labels:-(none)}"}\n\n${esc "$body_text"}"
          fi

          final="<b>$(esc "$msg_title")</b>\n${body}"
          echo "body=${final}" >> "$GITHUB_OUTPUT"

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID; skipping."
            exit 0
          fi
          body="${{ steps.build.outputs.body }}"
          curl -sS --fail -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${body}" \
            -d "parse_mode=HTML"
